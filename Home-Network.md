---
title: J1900软路由+小米AC2100 / OpenWRT —— 我的家庭网络方案
author: Gaein nidb
tags: 
- 软件教程
categories: [软件教程]
date: 2022-08-14 00:23:38
---

> 一定要勤备份配置

## 前言

~~我似乎好久好久没写过博客了~~

~~怎么感觉一不小心写成流水日记了~~

### 树莓派 server 时代

上学期疫情在家整整呆了半年，越看家里网络越不顺眼。以前是电信的光猫+华为路由器，不能用zt连学校资源，也不怎么好挂pt，也没有代理服务器（clash 跑在本机有些太费电）。于是着手弄我朋友送我的一个树莓派，刷单臂软路由，无奈 DHCP 一直配不好...结果就鸽子了，跑个 ubuntu server 当内网服务器用了...

### 折腾 OpenWRT 与 小米AC2100

后来在 TJUPT 内部群唠嗑90收了一个小米AC2100，我家的旧华为路由器海鲜市场卖了110，还挺神奇的。

于是，小米AC2100开始刷 OpenWRT，最开始在恩山上面找了许多包，不过都有些小问题（WLAN 得手动开的、配置防火墙卡死的...）直到用了我同学推荐的 [OpenWRT固件下载与在线定制编译](https://supes.top/)，一个大佬适配的固件，貌似是用 GithubAction 在线编译。虽然一些功能需要赞助才能开（自定义主机名之类的）不过也就无所谓了。光猫桥接、开 ipv6、拨号上网一气呵成，舒服多了。

### 公网IP 与 3965U 软路由

之后我家的网络大抵稳定了一段时间，直到看见同学找电信客服（或许是安徽电信）要了个公网IP，想了一想似乎也挺方便，我也去问问。不过河北的在线客服不能直接办，要留你的联系方式等着当地的维修师傅打电话。当时已经傍晚了，没想到过了一个小时师傅来了电话，和我谈妥了。他说明天上午保电信局审批，到时候告诉我，我重新拨号试试。我一觉呼呼大睡起来就有了。

关于公网 IP ，似乎电信要起来更方便一些。至于端口是 REJECT 了 `80`、 `443`、`8080` ，应该是工信部的要求。

寻思着都这样了，不如再搞个软路由挂 PT？正好很久以前拖欠的黑工工钱到了，就去海鲜市场买了个 3965U 软路由，4t HGST 的机械硬盘，一台 H3C 铁壳千兆交换机（问就是“企业级”）、AMP 的网线、mPCIE 千兆网卡...

外壳切了，把 mPCIE 网卡的 RJ45 口引出来。

mSATA 的硬盘没法插电脑，传统的镜像写入软件写不了硬盘，最后弄了个 WTG 在软路由本机刷机。

后来因为手贱更新之类又炸了两次，终于一切弄好装进弱电柜——电源炸了，连带主板一起开不开了。拔下电源万用表测输出 AC 12V，可能是整流器坏了...？

### J1900 软路由，一体化供电

弄都弄了，干脆又买了一台 J1900 （因为实在买不到那么便宜的 3965U 了），刷系统、小米 AC2100 刷系统做 ap...

另外有一点非常神奇的是，我所有的设备全是 12v 直流供电，因此直接买了一个 12v 直流电源（100W 的大概二三十）。服务器电源改 比较便宜但是弱电柜放不下，看了半天尺寸只好买了一个明纬的二手电源。

顺便 3.5 寸的 SATA 硬盘也需要一个 12v 供电，改了一个上去，5v 和 GND 依旧用软路由自带的供电。

![供电](https://img.cdn.gaein.cn/website_used/blog/Home-Network/01.webp)

看上去好危险啊（小声）

## 软路由 OpenWRT 安装

为了更方便的刷写 mSATA 硬盘，我买了一个 mSATA 转 SATA 的硬盘盒，再接一个 SATA 转 USB 的...

使用 [balenaEtcher](https://www.balena.io/etcher/) 可以刷写硬盘而不仅仅是 U 盘，当然，使用 Linux 系统的 `dd` 命令、或者在 WinPE 下使用 `physdiskwrite.exe` 来写入：

```sh
physdiskwrite.exe -u openwrt-21.02.0-x86-64-generic-ext4-combined.img.gz -d 0
```

安装完后直接进入系统即可，我在这遇到了一点小问题：我的机器无法进入 UEFI 固件设置，没办法改启动项，所以只好在 EFI 分区中编写 `startup.nsh` 脚本。

内容如下：

```efi
fs0:\efi\boot\bootx64.efi
```

## 配置软路由 OpenWRT

安装完系统后连接到软路由（网线、无线皆可）

### 拨号上网

更改 WAN 口为 “PPPOE”，输入宽带账号密码即可。IPv6将会自动分配。

![WAN口](https://img.cdn.gaein.cn/website_used/blog/Home-Network/02.webp)

> 如图，WAN 口显示的 IP 地址中，如果在 `192.168.0.0/16`、`172.16.0.0/12` 或 `10.0.0.0/8` 中的话，则是“私有地址”，即你运营商的大内网，除此之外分配给你的地址基本都会是“公网IP”。

### 连接到光猫设置页面

因为需要用路由器拨号，所以将光猫改为成“桥接模式”，光猫的 IP 地址为 `192.168.9.1`，因此我无法直接访问光猫的设置界面。

解决方案是在 WAN 口的设备上新增加一个 IP 在 `192.168.9.0/24` 子网的接口，通过该接口访问 `192.168.9.1`。

新建接口，命名为 “lan_wan” ，协议为“静态IP”，地址为 `192.168.9.2` （子网内的任意 IP 地址均可）。设备处选择“以太网适配器eth0”。

> 设备名可能会不同，留意一下 wan 口的连接设备即可。IP 地址仅作示范，具体还需要根据网络情况设置。

添加完成后在“高级设置”中，找到“使用网关跃点”项，填写为 `64` （或者任意一个较大的数字）。这样可以避免默认流量从非上网用的接口走。

> 网关跃点可以解释为类似于“优先级”的东西，跃点数越大代表“从这个网络走的代价越大”，即效果是优先级低。

配置完后路由器的路由表中将多出 `192.168.9.0/24 via 192.168.9.2` 这样类似的条目。以后再使用 192.168.9.1 访问光猫配置页面时候就会从这个口走了。

### Argon 主题设置

没想到吧接下来居然要说这个。

OpenWRT 官方的主题并谈不上好看，Edge 这个主题我又不是很喜欢。之前用过 [Infinity Freedom](https://www.right.com.cn/forum/thread-4003173-1-1.html) 这个主题，不过不是特别兼容我的系统，所以只好选择了经典的 `Argon` 来用。

在“软件包”中安装插件 `luci-app-argon-config` ，可以在 luci 中添加一个设置主题的界面。

然后来到设置界面中上传自己喜欢的壁纸，和更改自己喜欢的主题色。

我设置了 `#F19EC2` 作为我的主题色，不会有人不喜欢樱花粉吧？

![HEX预览](https://img.cdn.gaein.cn/website_used/blog/Home-Network/03.webp)

首页效果：

![效果图](https://img.cdn.gaein.cn/website_used/blog/Home-Network/04.webp)

### 对网段进行限速

有些莫名奇妙的需求，因为我家里所有设备全分配了静态 IP 地址：

1. 网络设备（路由器等） `192.168.8.1` - `192.168.8.31`；
2. Windows 设备（台式笔记本等） `192.168.8.32` - `192.168.8.47`；
3. 移动设备（手机） `192.168.8.48` - `192.168.8.63`；
4. DHCP地址 `192.168.8.64` - `192.168.8.127`；

所以在 `192.168.8.64` - `192.168.8.127` 段的设备基本都是客人之类的——总之不是家里的固定设备，所以想要进行限速。使用的插件如下：

1. luci-app-eqos

在插件后台启用，然后填写 `IP段` 进行限速就可以了。比如我需要限制的是 `192.168.8.64/26`

## 配置 AP OpenWRT

前前后后不知道配置了多少次...主要问题还是如果弄错了很可能就直接连不上后台了:D

主要的办法就是把 `WAN` 和 `LAN` 全接在一个接口上，`WLAN` 也接上去就行了，没有像厂家固件那样方便的改一个什么 “有线中继” 那么方便。作为 AP 的话真的很推荐使用原厂固件（但是 MiWiFi 一直在那请求 `api.miwifi.com` 在后台看 log 看的我实在心烦）

### NAT模式

能上网也是最省心的模式，构建的时候设置好一个不同于上面的 LAN IP 即可（比如 `192.168.7.1`），WAN 口设置 DHCP地址。

太不优雅啦（大声

### AP模式

参阅：

1. [[OpenWrt Wiki] Wireless Access Point / Dumb Access Point](https://openwrt.org/docs/guide-user/network/wifi/dumbap)

网络 > 接口 > 设备中选择 `br-lan` 的 “配置”，将接口中加入 `wan` 口。

关闭 `LAN` 口的 DHCP 服务器（我是根本没安装 Dnsmasq ）

将 `WAN` 口协议改为 “DHCP客户端” 或 “静态地址”

* 如果你的上级路由（比如软路由）配置好了静态地址给这台 AP，就可以用 “DHCP客户端”，管理起来也更方便；
* 如果静态地址没配好，那就选择“静态地址”并且填写一个同网段的地址（比如 `192.168.8.2`）；

将 `WAN` 口的防火墙区域改为 `lan`

将无线设置中接口由 `lan` 改到 `wan`

禁用防火墙

保存确认设置无误后删除 `lan` 接口（留着也可以，以备万一）

## 硬件改造

其实很多精力还花费在对弱电柜内部的改造上

### 改3.5硬盘供电

绝大多数工控小主机的 SATA 供电是为2.5寸硬盘设计的，2.5寸硬盘供电和3.5寸硬盘供电的主要区别就是2.5的少了一对 +12v 。所以我们只需要一个 12v 的直流电源，并且接到供电口就可以。

至于带有 12v 的 SATA 供电口，我手里有一个以前 ITX 用的，实在没有也可以考虑从旧的台式机 ATX 电源上面剪下来一个。

至于引脚定义详见下图：

![SATA供电口](https://img.cdn.gaein.cn/website_used/blog/Home-Network/05.webp)

正好接到我前言中说的 12v 开关电源上。

至于 SATA 线，我依旧是用锉刀挫开了一个槽，把线走了出去，千万注意不要太勉强，不然盖子把线压坏然后短路——后果不堪设想。

### 弱电柜里的铁架子

角钢真的是一种非常好的东西，便宜、而且非常容易 DIY，之前我的宿舍床上也是用这种角铁打了一个框架。至于价格的话，淘宝找那种卖二手角铁做货架的定制一下，我记得也就几十块钱。

只需要量好尺寸，想好放什么，比如我：

* 第一层：H3C 交换机
* 第二层：软路由
* 第三层：光猫

而且上面密密麻麻的孔洞非常适合绑扎带和走线

![弱电柜](https://img.cdn.gaein.cn/website_used/blog/Home-Network/06.webp)

> 虽然这还不是完全走好了之后的图，不过这么绑起来也很舒服

具体的各种配置有很多，前前后后也折腾了十天半个月，一些复杂一点的配置我就分开写博客再说（）